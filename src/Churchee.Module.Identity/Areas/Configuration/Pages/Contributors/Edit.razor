@page "/management/configuration/contributors/edit/{Id:guid}"
@inherits BasePage
@using Churchee.Common.Abstractions.Auth
@using Churchee.Common.Abstractions.Utilities
@using Churchee.Common.ValueTypes
@using Churchee.Module.Identity.Features.Contributors.Queries
@using Churchee.Module.Identity.Features.Roles.Queries
@using Churchee.Module.UI.Components
@using MediatR
@using Microsoft.AspNetCore.Components.Sections
@using Microsoft.AspNetCore.Mvc.Rendering
@using Microsoft.Extensions.Logging
@using Radzen
@using Radzen.Blazor

<PageName Name="Edit Contributor"></PageName>

@if (InputModel != null)
{
    <Form InputModel="@InputModel" OnSave=@(async () => await ValidSubmitForm(string.Empty))>
        <RadzenButton Text="Reset Password" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Button" Click=@(async () => await ValidSubmitForm("ResetPassword")) />
    </Form>
}

@code {
    [SupplyParameterFromForm]
    public EditContributorModel InputModel { get; set; }

    [Parameter]
    public Guid Id { get; set; }

    [Inject]
    private ICurrentUser CurrentUser { get; set; } = default!;

    [Inject]
    private ChurcheeUserManager UserManager { get; set; } = default!;

    [Inject]
    private IEmailService EmailService { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var roles = await Mediator.Send(new GetAllSelectableRolesForUserQuery(Id));

        InputModel = new(new MultiSelect(roles));
    }

    private async Task SendPasswordReset(){

        var user = await UserManager.FindByIdAsync(Id.ToString());

        if (user == null || !(await UserManager.IsEmailConfirmedAsync(user)))
        {
            NotificationService.Notify(NotificationSeverity.Error, "Failed to send password reset");

            return;
        }

        var code = await UserManager.GeneratePasswordResetTokenAsync(user);

        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));

        var callbackUrl = $"{NavigationManager.BaseUri}account/resetpassword?code={code}";

        if (callbackUrl == null)
        {
            Logger.Log(LogLevel.Error, "Callback URL is null. Check the Url.Page method parameters and ensure the page exists.");
        }

        var message = "Reset Password Link: " + callbackUrl;

        await EmailService.SendEmailAsync(user.Email, "Reset your password", message);

        NotificationService.Notify(NotificationSeverity.Success, "Password Reset send to Contributor");
    }


    private async Task UpdateContributor()
    {
        var user = await UserManager.FindByIdAsync(Id.ToString());

        if (user == null || !(await UserManager.IsEmailConfirmedAsync(user)))
        {
            NotificationService.Notify(NotificationSeverity.Error, "Failed to update Contributor");

            return;
        }

        var rolesNames = InputModel.Roles.Items.Where(w => InputModel.Roles.SelectedValues.Contains(w.Value)).Select(s => s.Text).ToList();

        var existingRoles = await UserManager.GetRolesAsync(user);

        var rolesToRemove = existingRoles.Where(w => !rolesNames.Contains(w)).ToList();

        var rolesToAdd = rolesNames.Where(w => !existingRoles.Contains(w)).ToList();

        await UserManager.RemoveFromRolesAsync(user, rolesToRemove);

        await UserManager.AddToRolesAsync(user, rolesToAdd);

        NotificationService.Notify(NotificationSeverity.Success, "Contributor Updated");

        NavigationManager.NavigateTo("/management/configuration/contributors");
    }

    private async Task ValidSubmitForm(string buttonText)
    {
        if (buttonText == "ResetPassword")
        {
            await SendPasswordReset();

            return;
        }

        await UpdateContributor();
    }
}
