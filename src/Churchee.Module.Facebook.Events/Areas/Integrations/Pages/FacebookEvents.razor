@page "/management/integrations/facebook-events"
@using Churchee.Module.Events.Features.Commands
@using Microsoft.AspNetCore.Http
@using Microsoft.Extensions.Logging
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Sections
@using MediatR
@using Churchee.Module.Facebook.Events.Areas.Integrations.Models
@using Churchee.Module.UI.Components
@using Radzen.Blazor
@using Radzen
@using Churchee.Common.Abstractions.Auth
@using Churchee.Module.Facebook.Events.Features.Queries
@using Churchee.Module.Facebook.Events.Features.Commands
@inject ILogger<FacebookEvents> Logger
@inject IMediator Mediator
@inject ICurrentUser _currentUser
@inject IHttpContextAccessor _httpContextAccessor
@inject NavigationManager NavigationManager

<PageName></PageName>

<div style="max-width: 900px; margin: 40px auto;">


    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="16" class="rz-m-5">

        <svg style="width: 100px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path fill="#0165E1" d="M160 96C124.7 96 96 124.7 96 160L96 480C96 515.3 124.7 544 160 544L258.2 544L258.2 398.2L205.4 398.2L205.4 320L258.2 320L258.2 286.3C258.2 199.2 297.6 158.8 383.2 158.8C399.4 158.8 427.4 162 438.9 165.2L438.9 236C432.9 235.4 422.4 235 409.3 235C367.3 235 351.1 250.9 351.1 292.2L351.1 320L434.7 320L420.3 398.2L351 398.2L351 544L480 544C515.3 544 544 515.3 544 480L544 160C544 124.7 515.3 96 480 96L160 96z" /></svg>
        <RadzenStack>
            <RadzenText TextStyle="TextStyle.H4" Text="Facebook Integration" />
            <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary); max-width: 600px;">
                Automatically fetch and display facebook events on your website.
            </RadzenText>
        </RadzenStack>

        @if (Linked)
        {
            <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Active" />
        }
        else
        {
            <RadzenBadge BadgeStyle="BadgeStyle.Base" Text="Inactive" />
        }

    </RadzenStack>

    <hr style="color: #eee; margin: 1rem 0" />


    @if (Linked)
    {
        <RadzenStack Orientation="Orientation.Vertical" JustifyContent="JustifyContent.Center">
            <h1>Facebook Events Sync is set up!</h1>

            <RadzenButton Click=@(args => DisableSync()) Text="Disable Sync" ButtonStyle="ButtonStyle.Danger" Icon="sync_disabled" />
            <RadzenButton Click=@(args => SyncNow()) Text="Sync Now" ButtonStyle="ButtonStyle.Primary" Icon="sync" />

        </RadzenStack>
    }
    else
    {
            <Form ButtonsOnTop="false" InputModel="@InputModel" OnSave=@(async () => await ValidSubmitForm("Enable")) />
    }

</div>


@code {

    public InputModel InputModel { get; set; } = new();

    [Inject]
    private NotificationService _notificationService { get; set; }

    public bool Linked { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        Linked = await Mediator.Send(new FacebookConfiguredQuery());
    }

    private async Task ValidSubmitForm(string submit)
    {
        if (submit == "Enable")
        {
            var request = _httpContextAccessor.HttpContext.Request;

            string redirectUrl = await Mediator.Send(new GetAuthUrlQuery($"{request.Scheme}://{request.Host}", InputModel.FacebookPageId));

            NavigationManager.NavigateTo(redirectUrl, true);
        }
        else
        {
            var createEventsResult = await Mediator.Send(new ActivateEventsCommand(await _currentUser.GetApplicationTenantId()));

            if (createEventsResult.IsSuccess)
            {
                await Mediator.Send(new SyncFacebookEventsToEventsTableCommand());
            }

        }
    }

    private async Task SyncNow()
    {
        var createEventsResult = await Mediator.Send(new ActivateEventsCommand(await _currentUser.GetApplicationTenantId()));

        if (!createEventsResult.IsSuccess)
        {
            return;
        }

        var syncResponse = await Mediator.Send(new SyncFacebookEventsToEventsTableCommand());

        if (!syncResponse.IsSuccess)
        {
            _notificationService.Notify(NotificationSeverity.Success, "Sync Completed");
        }
    }


    private async Task DisableSync()
    {
        var result = await Mediator.Send(new DisableFacebookSyncCommand());

        if (result.IsSuccess)
        {
            Linked = false;

            _notificationService.Notify(NotificationSeverity.Success, "Integration Disabled");

            InputModel = new InputModel();

            StateHasChanged();
        }
    }

}