@using Churchee.Common.ValueTypes
@using Radzen
@using Churchee.Module.UI.Models
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components;
@using System.Reflection
@using Microsoft.Extensions.Logging
@using Radzen.Blazor
@using System.ComponentModel.DataAnnotations
@using System.Linq.Expressions
@using Microsoft.AspNetCore.Mvc.Rendering
@using Radzen.Blazor.Rendering
    
<RadzenStack>

@foreach (var prop in Properties)
{
    string dataType = prop.PropertyType.Name;

    var dataTypeAttribute = prop.GetCustomAttribute<DataTypeAttribute>();

    var propertyValue = prop.GetValue(InputModel);

    string propertyStringValue = propertyValue?.ToString() ?? string.Empty;

    if (dataTypeAttribute != null)
    {
        dataType = dataTypeAttribute.DataType.ToString();

        if (dataType == "Custom")
        {
            dataType = dataTypeAttribute.CustomDataType ?? string.Empty;
        }
    }

    if (dataType == DataTypes.Hidden)
    {
        <input type="hidden" name="@(prop.Name)" value="@(prop.GetValue(InputModel))" />
    }

    if (dataType == DataTypes.TextWithSlug)
    {
        <TextWithSlug Name="@prop.Name" PropertyInfo="@prop" InputModel="InputModel" Value="@propertyStringValue" OnValueChanged=@(OnValueChanged) EditContext="EditContext"></TextWithSlug>
    }

    if (dataType == DataTypes.Upload)
    {
        var upload = prop.GetValue(InputModel) as Upload;

        if(upload != null)
        {
                <RadzenFileInput TValue="string" class="w-100" @bind-Value=@upload.Value @bind-FileName=@upload.FileName @bind-FileSize=@upload.Size Change=@(async args => await OnFileChangeAsync(upload)) InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "select file" }})" />
        }
    }

    if (dataType == DataTypes.ImageUpload)
    {
        var upload = prop.GetValue(InputModel) as Upload;

        if(upload != null)
        {
            <RadzenFileInput TValue="string" class="w-100" @bind-Value=@upload.Value @bind-FileName=@upload.FileName @bind-FileSize=@upload.Size Change=@(async args => await OnFileChangeAsync(upload)) Error=@(args => OnFileError(args, "FileInput")) Accept="image/*" InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "select image" }})" />
        }
    }

    if (dataType == DataTypes.ChunkedImageUpload)
    {
        var upload = prop.GetValue(InputModel) as ChunkedImageUploadType;

        if(upload != null)
        {
            <ChunkedImageUpload @bind-Model=upload></ChunkedImageUpload>
        }
    }

    if (dataType == DataTypes.MediaUpload)
    {
        var upload = prop.GetValue(InputModel) as Upload;

        if(upload != null)
        {
            <RadzenFormField Text=@prop.Name.ToSentence() AllowFloatingLabel="false">

                <RadzenFileInput TValue="string" class="w-100" @bind-Value=@upload.Value @bind-FileName=@upload.FileName @bind-FileSize=@upload.Size Change=@(async args => await OnFileChangeAsync(upload)) Error=@(args => OnFileError(args, "FileInput")) Accept=@(upload.SupportedFileTypes) InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "select document" }})" />

            </RadzenFormField>
        }
    }

    if (dataType == DataTypes.CheckboxList)
    {
        var multiSelect = prop.GetValue(InputModel) as MultiSelect ?? new MultiSelect(Enumerable.Empty<MultiSelectItem>());

        <RadzenCheckBoxList @bind-Value=@(multiSelect.SelectedValues) Data="@multiSelect.Items" TValue="Guid" TextProperty="Text" ValueProperty="Value" class="mb-5" Orientation=Orientation.Vertical></RadzenCheckBoxList>
    }

    if (dataType != DataTypes.Hidden && dataType != DataTypes.TextWithSlug && dataType != DataTypes.Upload && dataType != DataTypes.ImageUpload && dataType != DataTypes.MediaUpload && dataType != DataTypes.CheckboxList && dataType != DataTypes.ChunkedImageUpload)
    {
        var formFieldStyles = string.Empty;

        if (dataType == DataTypes.DateTime || dataType == DataTypes.Date)
        {
            formFieldStyles = "max-width:300px;";
        }

        <RadzenFormField Text=@prop.Name.ToSentence() Style="@formFieldStyles" AllowFloatingLabel="false">
                    <ChildContent>
                        @{
                            if (dataType == typeof(int).Name)
                            {
                                <RadzenNumeric TValue="int" Value="@(int.Parse(propertyStringValue))" Change=@((value) => OnFieldChange(prop, value)) />
                            }
                            if (Nullable.GetUnderlyingType(prop.PropertyType) == typeof(int))
                            {
                                <RadzenNumeric TValue="int?" Value="@(string.IsNullOrEmpty(propertyStringValue) ? (int?)null : int.Parse(propertyStringValue))" Change=@((value) => OnFieldChange(prop, value)) />
                            }
                            if (dataType == typeof(string).Name || dataType == DataTypes.Text)
                            {
                            <RadzenTextBox Name="@(prop.Name)" Value="@propertyStringValue" Change=@((value) => OnFieldChange(prop, value)) @onblur=@((value) => OnFieldChange(prop, prop.GetValue(InputModel))) />
                            }
                            if (prop.PropertyType == typeof(List<string>))
                            {
                                var list = prop.GetValue(InputModel) as List<string>;

                                if(list != null && list.Count > 0)
                                {
                                    <RadzenStack Gap="0">

                                      @for (int i = 0; i < list.Count; i++)
                                      {
                                            string name = $"{prop.Name}_{i}";
                                            var localIndex = i;

                                            string style = i < list.Count - 1 ? "border-bottom: 1px solid #e0e9f2; border-radius:0" : string.Empty;

                                            <RadzenTextBox Name="@name" Value="@list[i]" Change=@((value) => OnFieldChange(prop, localIndex, value)) Style="@style" @onblur="((value) => OnFieldChange(prop, localIndex, prop.GetValue(InputModel)?.ToString() ?? string.Empty))" />
                                      }

                                    </RadzenStack>

                                }

                            }

                            if (dataType == DataTypes.Password)
                            {
                                <RadzenPassword Name="@(prop.Name)" PropertyInfo="@prop" InputModel="InputModel" Value="@propertyStringValue" Change=@((value) => OnFieldChange(prop, value))></RadzenPassword>
                            }
                            if (dataType == DataTypes.EmailAddress)
                            {
                                <RadzenTextBox Name="@(prop.Name)" Value="@propertyStringValue" Change=@((value) => OnFieldChange(prop, value)) />
                            }

                            if (dataType == DataTypes.DateTime)
                            {
                                <RadzenDatePicker Name="@(prop.Name)" DateFormat="dd-MM-yyyy HH:mm" ShowTime="true" TValue="DateTime" Value=@prop.GetValue(InputModel) Change=@((value) => OnFieldChange(prop, value)) />
                            }

                            if (dataType == DataTypes.Date)
                            {
                                <RadzenDatePicker Name="@(prop.Name)" DateFormat="dd-MM-yyyy" ShowTime=false TValue="DateTime" Value=@prop.GetValue(InputModel) Change=@((value) => OnFieldChange(prop, value))/>
                            }

                            if (dataType == DataTypes.Url)
                            {
                                <RadzenTextBox Name="@(prop.Name)" Value="@propertyStringValue" Change=@((value) => OnFieldChange(prop, value)) />
                            }

                            if (dataType == DataTypes.Readonly)
                            {
                                <RadzenTextBox Name="@(prop.Name)" Value="@propertyStringValue" ReadOnly=true />
                            }

                            if (dataType == DataTypes.MultilineText)
                            {
                                int rows = 2;

                                var maxLengthDataAttribute = prop.GetCustomAttribute<MaxLengthAttribute>();

                                if (maxLengthDataAttribute != null)
                                {
                                    rows = Math.Max(2, (maxLengthDataAttribute.Length / 50));
                                }

                                <RadzenTextArea Name="@prop.Name" Value="@propertyStringValue" Change=@((value) => OnFieldChange(prop, value)) class="w-100" Rows="rows" aria-label="TextArea" />
                            }

                            if (dataType == DataTypes.CssEditor)
                            {
                                <CssEditor Value="@propertyStringValue" Change=@((value) => OnFieldChange(prop, value))></CssEditor>
                            }
                            if (dataType == DataTypes.RazorEditor)
                            {
                                <RazorEditor Value="@propertyStringValue" Change=@((value) => OnFieldChange(prop, value))></RazorEditor>
                            }

                            if (dataType == DataTypes.GeoCoordinates)
                            {
                                <RadzenNumeric TValue="decimal?" Format="#.0000" Value="@(GetParsed<Decimal>(prop, InputModel))" Change=@((value) => OnFieldChange(prop, value))></RadzenNumeric>
                            }

   
                            if (dataType == DataTypes.Html)
                            {

                                <RadzenHtmlEditor Value="@propertyStringValue" Change=@((value) => OnFieldChange(prop, value)) Style="height: 250px">
                                    <RadzenHtmlEditorFormatBlock />
                                    <RadzenHtmlEditorUndo />
                                    <RadzenHtmlEditorRedo />
                                    <RadzenHtmlEditorSeparator />
                                    <RadzenHtmlEditorBold />
                                    <RadzenHtmlEditorItalic />
                                    <RadzenHtmlEditorUnderline />
                                    <RadzenHtmlEditorStrikeThrough />
                                    <RadzenHtmlEditorSeparator />
                                    <RadzenHtmlEditorRemoveFormat />
                                    <RadzenHtmlEditorLink />
                                    <RadzenHtmlEditorUnorderedList />
                                    <RadzenHtmlEditorOrderedList />
                                    <RadzenHtmlEditorSource />
                                </RadzenHtmlEditor>
                            }
                            if (dataType == DataTypes.HtmlNoLinks)
                            {
                                <RadzenHtmlEditor Value="@propertyStringValue" Change=@((value) => OnFieldChange(prop, value)) Style="height: 250px">
                                    <RadzenHtmlEditorFormatBlock />
                                    <RadzenHtmlEditorUndo />
                                    <RadzenHtmlEditorRedo />
                                    <RadzenHtmlEditorSeparator />
                                    <RadzenHtmlEditorBold />
                                    <RadzenHtmlEditorItalic />
                                    <RadzenHtmlEditorUnderline />
                                    <RadzenHtmlEditorStrikeThrough />
                                    <RadzenHtmlEditorSeparator />
                                    <RadzenHtmlEditorRemoveFormat />
                                    <RadzenHtmlEditorUnorderedList />
                                    <RadzenHtmlEditorOrderedList />
                                    <RadzenHtmlEditorSource />
                                </RadzenHtmlEditor>
                            }
                            if (dataType == DataTypes.HtmlTall)
                            {

                                <RadzenHtmlEditor Value="@propertyStringValue" Change=@((value) => OnFieldChange(prop, value)) Style="height: 420px">
                                    <RadzenHtmlEditorFormatBlock />
                                    <RadzenHtmlEditorUndo />
                                    <RadzenHtmlEditorRedo />
                                    <RadzenHtmlEditorSeparator />
                                    <RadzenHtmlEditorBold />
                                    <RadzenHtmlEditorItalic />
                                    <RadzenHtmlEditorUnderline />
                                    <RadzenHtmlEditorStrikeThrough />
                                    <RadzenHtmlEditorSeparator />
                                    <RadzenHtmlEditorRemoveFormat />
                                    <RadzenHtmlEditorLink />
                                    <RadzenHtmlEditorUnorderedList />
                                    <RadzenHtmlEditorOrderedList />
                                    <EditorButton Title="Insert Image" Click=@OpenImageUploadEditor Icon="image"/>
                                    <RadzenHtmlEditorSource />
                                </RadzenHtmlEditor>
                            }       


                            if (dataType == typeof(DropdownInput).Name)
                            {
                                var dropdown = prop.GetValue(InputModel) as DropdownInput ?? new DropdownInput();

                                <RadzenDropDown Data=dropdown.Data TextProperty="Title" ValueProperty="Value" Value="dropdown.Value" Change=@((value) => OnDropdownFieldChange(prop, value)) />
                            }
                        }

                    </ChildContent>
                    <Helper>
                        @if (dataType != DataTypes.Hidden)
                        {
                                <ValidationMessage For="GetExpression(prop, InputModel)" />
                        }

                    </Helper>


                </RadzenFormField>

    }

}

</RadzenStack>


@code{

    [Inject]
    protected ILogger<Form> _logger { get; set; } = default!;

    [Inject]
    protected DialogService _dialogService { get; set; } = default!;

    [Inject]
    protected NotificationService _notificationService { get; set; } = default!;

    [Parameter]
    public EditContext EditContext { get; set; } = default!;

    [Parameter]
    public object InputModel { get; set; } = default!;

    [Parameter]
    public IEnumerable<PropertyInfo> Properties { get; set; } = default!;

    [Parameter]
    public bool FormInvalid { get; set; }

    [Parameter]
    public bool SubmitClicked { get; set; }

    [Parameter]
    public EventCallback<ImageUploadModel> OnImageSubmit { get; set; }

    public async Task OnFieldChange(PropertyInfo info, object? value)
    {

        info.SetValue(InputModel, value);

        // Get the FieldIdentifier with the EditContext from the field name
        FieldIdentifier fieldIdentifier = EditContext.Field(info.Name);

        // Validate the field when notifying change
        EditContext.NotifyFieldChanged(fieldIdentifier);

        await OnValueChanged.InvokeAsync(null);
    }

    public async Task OnFieldChange(PropertyInfo info, int index, string? value)
    {
        if (info.GetValue(InputModel) is List<string> list && index >= 0 && index < list.Count)
        {
            list[index] = value ?? string.Empty; // Ensure non-null assignment

            // Get the FieldIdentifier for validation
            FieldIdentifier fieldIdentifier = EditContext.Field($"{info.Name}_{index}");
            EditContext.NotifyFieldChanged(fieldIdentifier);

            await OnValueChanged.InvokeAsync(null);
        }
    }

    public async Task OnTextWithSlugFieldChange(PropertyInfo info, object value)
    {
        info.SetValue(InputModel, value);

        await OnValueChanged.InvokeAsync(null);
    }

    public async Task OnDropdownFieldChange(PropertyInfo info, object value)
    {
        var dropdown = info.GetValue(InputModel) as DropdownInput ?? new DropdownInput();

        var stringValue = value?.ToString() ?? string.Empty;

        dropdown.Value = stringValue;
        dropdown.Title = dropdown.Data.Where(w => w.Value == stringValue).Select(s => s.Title).FirstOrDefault() ?? string.Empty;

        info.SetValue(InputModel, dropdown);

        await OnValueChanged.InvokeAsync(null);

    }

    async Task OnFileChangeAsync(Upload upload)
    {
        _logger.LogInformation("{Upload} value changed", upload);

        await OnValueChanged.InvokeAsync(null);
    }

    private static Nullable<T> GetParsed<T>(PropertyInfo info, object inputModel) where T: struct
    {
        var value = info.GetValue(inputModel);

        if(value != null)
        {
            return (T)value;
        }

        return null;
    }


    public ImageUploadModel ImageUploadModel { get; set; } = new();


    async Task OpenImageUploadEditor()
    {
       await _dialogService.OpenAsync("Insert image", ds =>

            @<ModalForm InputModel="ImageUploadModel" OnCancelForm=@(async () => await OnCancelImageUpload(ds)) OnSave=@(async () => await ValidImageUpload(ds)) />,
            new DialogOptions() { Width = "700px"}

        );    

    }

    private async Task OnCancelImageUpload(DialogService ds)
    {
        await Task.Run(() =>
        {
            ds.Close();
            ImageUploadModel = new ImageUploadModel();
        });
    }

    private async Task ValidImageUpload(DialogService ds)
    {
        await OnImageSubmit.InvokeAsync(ImageUploadModel);
        ds.Close();
    }

    void OnFileError(UploadErrorEventArgs args, string name)
    {
        if (args.Message.Contains("File too large"))
        {
            _notificationService.Notify(NotificationSeverity.Error, "File size to large. Max upload size is 5MB");
        }
        else
        {
            _notificationService.Notify(NotificationSeverity.Error, "Error uploading file");
        }

        _logger.LogInformation("{Name} value error", name);
    }

    private static Expression<Func<object>> GetExpression(PropertyInfo info, object inputModel)
    {
        // Create an expression to set the ValueExpression-attribute.
        var constant = System.Linq.Expressions.Expression.Constant(inputModel, inputModel.GetType());
        var exp = System.Linq.Expressions.MemberExpression.Property(constant, info.Name);
        var conversion = Expression.Convert(exp, typeof(object));
        var lamb = System.Linq.Expressions.Expression.Lambda<Func<object>>(conversion);

        return lamb;
    }

    [Parameter]
    public EventCallback<object> OnValueChanged { get; set; }

}