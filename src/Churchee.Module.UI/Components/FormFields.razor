@using Churchee.Common.ValueTypes
@using Radzen
@using System.Reflection
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq
@using Churchee.Module.UI.Models
@using Radzen.Blazor

<RadzenStack>

@{
    // Group properties by DisplayAttribute.GroupName (empty string for no group)
    var groupedProps = Properties
        .GroupBy(p => p.GetCustomAttribute<DisplayAttribute>()?.GroupName ?? string.Empty)
        .ToList();
}

@foreach (var group in groupedProps)
{
    var groupName = group.Key;

    if (!string.IsNullOrEmpty(groupName))
    {
        <div class="rz-card" style="margin-bottom:1rem;">
            <div class="rz-card-header" style="padding:0.5rem 1rem; font-weight:600;">
                @groupName
            </div>
            <div class="rz-card-body" style="padding:1rem;">
                @foreach (var prop in group)
                {
                    <FormFieldItem Prop="prop" InputModel="InputModel" EditContext="EditContext" OnValueChanged="OnValueChanged" OnImageSubmit="OnImageSubmit" />
                }
            </div>
        </div>
    }
    else
    {
        @foreach (var prop in group)
        {
                <FormFieldItem Prop="prop" InputModel="InputModel" EditContext="EditContext" OnValueChanged="OnValueChanged" OnImageSubmit="OnImageSubmit" />
        }
    }
}

</RadzenStack>

@code {
    [Parameter]
    public EditContext EditContext { get; set; } = default!;

    [Parameter]
    public object InputModel { get; set; } = default!;

    [Parameter]
    public IEnumerable<PropertyInfo> Properties { get; set; } = default!;

    [Parameter]
    public EventCallback<object> OnValueChanged { get; set; }

    [Parameter]
    public EventCallback<ImageUploadModel> OnImageSubmit { get; set; }
}