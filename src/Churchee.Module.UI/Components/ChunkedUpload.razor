@using Churchee.Common.Abstractions.Auth
@using Churchee.Common.Storage
@using Microsoft.AspNetCore.Components.Forms
@using System.Globalization
@using Microsoft.JSInterop
@using Radzen
@using Radzen.Blazor


<RadzenUpload Change="HandleFileUpload" Auto="false" Multiple="false" />

@if (uploadProgress > 0 && uploadProgress < 100)
{
    <RadzenProgressBar ProgressBarStyle="ProgressBarStyle.Primary" Value="uploadProgress" ShowValue="false" />
}
@if (uploadProgress == 100)
{
    <RadzenProgressBar ProgressBarStyle="ProgressBarStyle.Success" Value="100" ShowValue="false" />
}


<small>@status</small>

@code {

    [Inject]
    private ICurrentUser CurrentUser { get; set; } = default!;

    [Inject]
    private IBlobStore Store { get; set; } = default!;

    [Parameter]
    public string Path { get; set; } = string.Empty;

    [Parameter]
    public string Name { get; set; } = string.Empty;

    [Parameter]
    public int MaxUploadSize { get; set; } = 5;

    private double uploadProgress = 0;

    private string status = string.Empty;

    private async Task HandleFileUpload(UploadChangeEventArgs e)
    {
        var file = e.Files.FirstOrDefault() as IBrowserFile;

        if(file == null)
        {
            uploadProgress = 0;

            status = string.Empty;

            StateHasChanged();

            return;
        }

        var savePath = System.IO.Path.Combine(Path, file.Name);

        await SaveFileInChunks(file, savePath);

        status = $"Uploaded {file.Name}";
        
    }

    private async Task SaveFileInChunks(IBrowserFile file, string savePath)
    {
        var applicationTenantId = await CurrentUser.GetApplicationTenantId(); 

        // Create a progress reporter that updates the uploadProgress variable
        var progress = new Progress<double>(value =>
        {
            uploadProgress = value; // value is 0.0 to 1.0, convert to percent
            InvokeAsync(StateHasChanged); // Ensure UI updates
        });

        await Store.WriteChunksAsync(applicationTenantId, savePath, file, progress);

    }
}