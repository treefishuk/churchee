@using Churchee.Module.UI.Models
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components;


    @if (isLoading)
    {
        <RadzenProgressBarCircular Style="width:100%" ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate"></RadzenProgressBarCircular>
    }

<img src="@FullImageUrl" @onload="OnImageLoad" @onerror="HandleError" alt="@AltText" style="display:@(isLoading ? "none" : "block"); width:100%; height:auto; @Styles" crossorigin />


@code {

    private bool isLoading = true;

    [Parameter]
    public string Styles { get; set; } = string.Empty;

    [Parameter]
    public string Prefix { get; set; } = string.Empty;

    [Parameter]
    public string AltText { get; set; } = string.Empty;

    [Parameter]
    public string ImageUrl { get; set; } = string.Empty;


    private string FullImageUrl 
    {
        get
        {

            if (ImageUrl.StartsWith("https"))
            {
                return ImageUrl;
            }

            if (ImageUrl.StartsWith("/_content"))
            {
                return ImageUrl;
            }

            return Prefix + ImageUrl;

        }

    }

    private void OnImageLoad()
    {
        isLoading = false;
    }

    private bool IsNotOriginal(string fileName)
    {
        return fileName.EndsWith("_t") || fileName.EndsWith("_s") || fileName.EndsWith("_m") || fileName.EndsWith("_l");
    }

    private void HandleError()
    {
        string fileName = Path.GetFileNameWithoutExtension(ImageUrl);
        string directory = Path.GetDirectoryName(ImageUrl) ?? string.Empty;
        string fileExt = Path.GetExtension(ImageUrl);

        if (IsNotOriginal(fileName))
        {

            fileName = fileName.Substring(0, fileName.Length - 2);

            ImageUrl = Path.Combine(directory, fileName + fileExt);

            return;
        }

        ImageUrl = "/_content/Churchee.Module.UI/img/not-found.png";
    }
}
