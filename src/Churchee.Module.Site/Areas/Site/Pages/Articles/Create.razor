@page "/management/articles/create"
@inherits BasePage
@using Churchee.Module.Site.Areas.Site.Models
@using Churchee.Module.Site.Features.Blog.Commands
@using Churchee.Module.Site.Features.PageTypes.Queries
@using Churchee.Module.Site.Features.Pages.Commands
@using Churchee.Module.Site.Features.Pages.Commands.CreatePage
@using Churchee.Module.Site.Features.Pages.Queries
@using Churchee.Module.UI.Components
@using Churchee.Module.UI.Models
@using Radzen
@using Radzen.Blazor
@using Radzen.Blazor.Rendering
@using Path = System.IO.Path;

<PageName Name="Create Article"></PageName>


<Form InputModel="@InputModel" OnSave=@(async () => await ValidSubmitForm())>

    <RadzenButton Id="distractionFreeModeBtn" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Button" Click="@(() => OpenContentEditor())">Distraction Free Mode</RadzenButton>

</Form>

@code {
    [SupplyParameterFromForm]
    public CreateArticleModel InputModel { get; set; } = new();

    public ImageUploadModel ImageUploadModel { get; set; } = new();

    [Parameter]
    public Guid Id { get; set; }

    [Inject]
    private DialogService DialogService { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await Mediator.Send(new SeedDefaultArticlesListingIfNeededCommand());

        var parentsDropdownData = await GetParentOptions();

        InputModel = new CreateArticleModel()
        {
            Parent = new DropdownInput
            {
                Data = parentsDropdownData ?? new List<DropdownInput>()
            }
        };


    }

    private async Task ValidSubmitForm()
    {
        var command = new CreateArticleCommand
        {
            Title = InputModel.Title,
            Description = InputModel.Description,
            PublishOnDate = InputModel.PublishOnDate,
            Content = InputModel.Content,
            ParentPageId = Guid.Parse(InputModel.Parent?.Value)
        };

        var result = await Mediator.Send(command, default);

        if (result.IsSuccess)
        {
            NavigationManager.NavigateTo("/management/articles");
        }

    }

    private async Task<IEnumerable<DropdownInput>> GetParentOptions()
    {
        return await Mediator.Send(new GetParentArticlePagesDropdownDataQuery(), default);
    }
    
    private async Task OpenContentEditor()
    {
       await DialogService.OpenAsync("Update Content", ds =>

                                @<RadzenHtmlEditor @bind-Value=InputModel.Content Style="height: 89vh">
                                    <RadzenHtmlEditorFormatBlock />
                                    <RadzenHtmlEditorUndo />
                                    <RadzenHtmlEditorRedo />
                                    <RadzenHtmlEditorSeparator />
                                    <RadzenHtmlEditorBold />
                                    <RadzenHtmlEditorItalic />
                                    <RadzenHtmlEditorUnderline />
                                    <RadzenHtmlEditorStrikeThrough />
                                    <RadzenHtmlEditorSeparator />
                                    <RadzenHtmlEditorRemoveFormat />
                                    <RadzenHtmlEditorSource />
                                    <RadzenHtmlEditorUnorderedList />
                                    <RadzenHtmlEditorOrderedList />
                                    <EditorButton Title="Insert Image" Click=@OpenImageUploadEditor Icon="image"/>
                                </RadzenHtmlEditor>,
            new DialogOptions() { Width = "100%", Height = "100%"}
        );    

    }

    async Task OpenImageUploadEditor()
    {
       await DialogService.OpenAsync("Insert image", ds =>

            @<ModalForm InputModel="ImageUploadModel" OnCancelForm=@(async () => await OnCancelImageUpload(ds)) OnSave=@(async () => await OnSaveImageUpload(ds)) />,
            new DialogOptions() { Width = "700px"}

        );    

    }

    private async Task OnCancelImageUpload(DialogService ds)
    {
        await Task.Run(() =>
        {
            ds.Close();
            ImageUploadModel = new ImageUploadModel();
        });
    }

    private async Task OnSaveImageUpload(DialogService ds)
    {
        await OnImageSubmit(ImageUploadModel);

        await Task.Run(() =>
        {
            ds.Close();
        });

    }

    private async Task OnImageSubmit(ImageUploadModel model)
    {
        NotificationService.Notify(NotificationSeverity.Success, "Image Added");

        var command = new UploadArticleImageCommand.Builder()
        .SetFileName(Path.GetFileNameWithoutExtension(model.File.FileName))
        .SetExtension(Path.GetExtension(model.File.FileName))
        .SetDescription(model.Description)
        .SetBase64Content(model.File.Value)
        .SetWidth(model.Width)
        .Build();

        var result = await Mediator.Send(command);

        InputModel.Content += result.ImageHtml;
    }
}
