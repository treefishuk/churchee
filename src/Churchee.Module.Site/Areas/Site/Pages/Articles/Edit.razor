@page "/management/articles/edit/{Id:guid}"
@inherits BasePage
@using Churchee.Module.Site.Areas.Site.Models
@using Churchee.Module.Site.Features.Blog.Commands
@using Churchee.Module.Site.Features.Blog.Queries
@using Churchee.Module.Site.Features.PageTypes.Queries
@using Churchee.Module.Site.Features.Pages.Commands
@using Churchee.Module.Site.Features.Pages.Commands.CreatePage
@using Churchee.Module.Site.Features.Pages.Queries
@using Churchee.Module.UI.Components
@using Churchee.Module.UI.Models
@using Radzen
@using Radzen.Blazor

<PageName Name="Edit Article"></PageName>


<Form InputModel="@InputModel" OnSave=@(async () => await ValidSubmitForm())>

    <RadzenButton ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Button" Click="@(() => OpenContentEditor())">Distraction Free Mode</RadzenButton>

</Form>

@code {
    [SupplyParameterFromForm]
    public EditArticleModel InputModel { get; set; } = new();

    [Parameter]
    public Guid Id { get; set; }

    [Inject]
    private DialogService DialogService { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var data = await Mediator.Send(new GetArticleByIdQuery(Id), default);

        var parentsDropdownData = await GetParentOptions();

        InputModel = new EditArticleModel()
        {
            Parent = new DropdownInput
            {
                Title = data.ParentName,
                Value = data.ParentId?.ToString().ToUpperInvariant(),
                Data = parentsDropdownData ?? new List<DropdownInput>()
            },
            Content = data.Content ?? string.Empty,
            Title = data.Title ?? string.Empty,
            Description = data.Description ?? string.Empty,
            PublishOnDate = data.PublishOnDate
        };
    }

    private async Task ValidSubmitForm()
    {
        var command = new CreateArticleCommand
        {
            Title = InputModel.Title,
            Description = InputModel.Description,
            PublishOnDate = InputModel.PublishOnDate,
            Content = InputModel.Content,
            ParentPageId = Guid.Parse(InputModel.Parent?.Value)
        };

        var result = await Mediator.Send(command, default);

        if (result.IsSuccess)
        {
            NavigationManager.NavigateTo("/management/articles");
        }

    }

    private async Task<IEnumerable<DropdownInput>> GetParentOptions()
    {
        return await Mediator.Send(new GetParentArticlePagesDropdownDataQuery(), default);
    }
    
    private async Task OpenContentEditor()
    {
       await DialogService.OpenAsync("Update Content", ds =>

                                @<RadzenHtmlEditor @bind-Value=InputModel.Content Style="height: 89vh">
                                    <RadzenHtmlEditorFormatBlock />
                                    <RadzenHtmlEditorUndo />
                                    <RadzenHtmlEditorRedo />
                                    <RadzenHtmlEditorSeparator />
                                    <RadzenHtmlEditorBold />
                                    <RadzenHtmlEditorItalic />
                                    <RadzenHtmlEditorUnderline />
                                    <RadzenHtmlEditorStrikeThrough />
                                    <RadzenHtmlEditorSeparator />
                                    <RadzenHtmlEditorRemoveFormat />
                                    <RadzenHtmlEditorSource />
                                    <RadzenHtmlEditorUnorderedList />
                                    <RadzenHtmlEditorOrderedList />
                                </RadzenHtmlEditor>,
            new DialogOptions() { Width = "100%", Height = "100%"}
        );    

    }
}
