@page "/management/media"
@using Churchee.Module.Site.Features.CDN.Queries
@using Churchee.Module.Site.Features.Media.Commands
@using Churchee.Module.Site.Features.Media.Queries
@using MediatR
@using Microsoft.AspNetCore.Components.Sections
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Extensions.Logging
@using Microsoft.JSInterop
@using Radzen.Blazor
@using Radzen
@using Churchee.Module.UI.Components
@using Churchee.Module.Site.Areas.Site.Models


<PageName Name="Media"></PageName>

<SectionContent SectionName="top-bar">

    <div class="rz-breadcrumb-item">

        <div class="rz-m-3">

            <RadzenSplitButton Click="@FolderAction"
                               Text="Folder"
                               ButtonStyle="ButtonStyle.Info">

                <ChildContent>

                    <RadzenSplitButtonItem Text="Add Folder" Value="Add" />

                    <RadzenSplitButtonItem Text="Delete Folder" Value="Delete" />

                    <RadzenSplitButtonItem Text="Clear Selection Folder" Value="Clear" />

                </ChildContent>

            </RadzenSplitButton>

        </div>

        <RadzenButton Click=@(args => AddMediaItem()) Text="Add Media Item" ButtonStyle="ButtonStyle.Secondary" bind-dis Disabled=AddMediaDisabled />
    </div>

</SectionContent>

        <RadzenStack Orientation="Orientation.Horizontal" Gap="0" AlignItems="AlignItems.Stretch" Style="height:100%;">
            <RadzenTree @ref="tree" @bind-Value=@activeFolder Change="@LogChange" Data="@Directories" Expand="@LoadDirectory" Style="width: 500px; margin-right: 1rem; min-width: 500px; height: 100%; padding: 1rem 5rem 1rem 1rem; background: #dde5ec; border:1px solid #d9d8d8">
                <RadzenTreeLevel HasChildren=@HasChildren ChildrenProperty="Children" Text="@GetTextForNode" Template="@FolderTemplate" />
            </RadzenTree>
            <RadzenDataList AllowVirtualization=@allowVirtualization Style="height:100%; width:100%; overflow:auto;"
                        WrapItems="true" AllowPaging="@(!allowVirtualization)"
                        Data="@data" TItem="GetMediaListForFolderQueryResponseItem" PageSize="12" PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true">

            <Template Context="item">

            <div style="width:25%; height: 100%; max-width: 25%; min-width: 150px; padding: 0; margin: 0; background: none; border: none;">

                <RadzenCard Style="margin: 5px">

                                <div class="rz-image-wrap" style="width:100%;">
                                        <Image Prefix="@imagePrefix" ImageUrl="@(item.MediaUrlSmall)" AltText="@item.Title" Styles="width: 100%; height: 200px; object-fit:cover;"></Image>
                               </div>

                                <RadzenStack Orientation="Orientation.Horizontal" Gap="4px" AlignItems="AlignItems.Start" Style="padding: 1rem 0 0;">
                                    <RadzenButton Click=@(args => OnEdit(item.Id)) Icon="edit" ButtonStyle="ButtonStyle.Primary" />
                                    <RadzenButton Click=@(args => OnDelete(item.Id)) Icon="delete" ButtonStyle="ButtonStyle.Danger" />
                                    <RadzenButton Click=@(args => OpenImage(imagePrefix, item.MediaUrl)) Icon="open_in_new" ButtonStyle="ButtonStyle.Secondary" />
                                </RadzenStack>


                </RadzenCard>

            </div>

            </Template>
        </RadzenDataList>  

        </RadzenStack>


@code {

    [Inject]
    private ILogger<Index> Logger { get; set; } = default!;

    [Inject]
    private IMediator Mediator { get; set; } = default!;

    [Inject]
    private DialogService DialogService { get; set; } = default!;

    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;

    [Inject]
    private NotificationService NotificationService { get; set; } = default!;

    [Inject]
    private IJSRuntime JSRuntime { get; set; }

    private RadzenTree tree;

    string NewFolderName = "";

    string imagePrefix = "";

    bool AddMediaDisabled => activeFolder == null;

    bool allowVirtualization;

    object activeFolder = null;

    Guid? activeFolderId = (Guid?)null;

    IEnumerable<GetMediaListForFolderQueryResponseItem> data;

    CreateMediaItemModel createModel = new CreateMediaItemModel();

    EditMediaItemModel editModel = new EditMediaItemModel();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        imagePrefix = await Mediator.Send(new GetCDNPathQuery());

        Directories = await Mediator.Send(new GetMediaFoldersQuery(null));
    }

    private async Task OnCancelEdit(DialogService ds)
    {
        ds.Close();
        editModel = new EditMediaItemModel();
    }

    private async Task OnDelete(Guid id)
    {
        var result = await Mediator.Send(new DeleteMediaItemCommand(id));

        if (result.IsSuccess)
        {
            data = await Mediator.Send(new GetMediaListForFolderQuery(activeFolderId));

            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Media Item Removed" });
        }
    }

    private async Task OnEdit(Guid id)
    {
        var selected = data.FirstOrDefault(w => w.Id == id);

        editModel.Name = selected.Title;
        editModel.Description = selected.Description ?? string.Empty;
        editModel.AdditionalContent = selected.AdditionalContent ?? string.Empty;
        editModel.LinkUrl = selected.LinkUrl ?? string.Empty;

        var result = await DialogService.OpenAsync("Edit Media Item", ds =>
        @<ModalForm InputModel="editModel" OnCancelForm=@(async () => await OnCancelEdit(ds)) OnSave=@(async () => await ValidEditSubmitForm(id)) />
    );
    }

    private async Task AddMediaItem()
    {
        var result = await DialogService.OpenAsync("Add Media Item", ds =>
        @<ModalForm InputModel="createModel" OnCancelForm=@(async () => await OnCancelEdit(ds)) OnSave=@(async () => await ValidCreateSubmitForm()) />
        );

    }

    IEnumerable<GetMediaFoldersQueryResponseItem> Directories = new List<GetMediaFoldersQueryResponseItem>();

    private async Task ValidCreateSubmitForm()
    {
        var result = await Mediator.Send(new CreateMediaItemCommand(createModel.Name, Path.GetFileNameWithoutExtension(createModel.File.FileName), Path.GetExtension(createModel.File.FileName), createModel.Description, createModel.AdditionalContent, activeFolderId, createModel.File.Value, createModel.LinkUrl));

        if (result.IsSuccess)
        {
            DialogService.Close();

            data = await Mediator.Send(new GetMediaListForFolderQuery(activeFolderId));

            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Media Item Added" });
            
            createModel = new CreateMediaItemModel();

        }

        if (!result.IsSuccess)
        {
            foreach (var error in result.Errors)
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = error.Description, Duration = 5000 });
            }
        }

    }

    private async Task ValidEditSubmitForm(Guid id)
    {
        var result = await Mediator.Send(new UpdateMediaItemCommand(id, editModel.Name, Path.GetFileNameWithoutExtension(editModel.File.FileName), Path.GetExtension(editModel.File.FileName), editModel.LinkUrl, editModel.Description, editModel.AdditionalContent, editModel.File.Value));

        if (result.IsSuccess)
        {
            DialogService.Close();

            data = await Mediator.Send(new GetMediaListForFolderQuery(activeFolderId));

            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Media Item Updated" });

            editModel = new EditMediaItemModel();

        }

        if (!result.IsSuccess)
        {
            foreach(var error in result.Errors)
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = error.Description });
            }
        }

    }

    bool HasChildren(object data)
    {
        var item = data as GetMediaFoldersQueryResponseItem;

        return item.HasChildren;
    }

    string GetTextForNode(object data)
    {
        var item = data as GetMediaFoldersQueryResponseItem;

        return item.Title;
    }

    RenderFragment<RadzenTreeItem> FolderTemplate = (context) => builder =>
    {
        builder.OpenComponent<RadzenIcon>(0);
        builder.AddAttribute(1, "Icon", "folder");
        builder.AddAttribute(2, "Style", "margin-left: 24px");
        builder.CloseComponent();
        builder.AddContent(3, context.Text);

    };

    async Task LogChange(TreeEventArgs args)
    {
        activeFolder = args.Value;

        var active = args.Value as GetMediaFoldersQueryResponseItem;

        activeFolderId = active.Id;

        data = await Mediator.Send(new GetMediaListForFolderQuery(active.Id));

    }

    async Task LoadDirectory(TreeExpandEventArgs args)
    {
        var item = args.Value as GetMediaFoldersQueryResponseItem;

        item.Children = await Mediator.Send(new GetMediaFoldersQuery(item.Id));

        args.Children.Data = item.Children;

        args.Children.Template = FolderTemplate;

        args.Children.Text = GetTextForNode;

        args.Children.HasChildren = HasChildren;

    }

    async Task FolderAction(RadzenSplitButtonItem item)
    {
        if (item == null || item.Value == "Add")
        {
                var result = await DialogService.OpenAsync("Add Folder", ds =>
                @<RadzenStack Gap="1.5rem">

                    <RadzenTextBox Placeholder="Folder Name"
                                   @bind-Value="NewFolderName"
                                   Style="margin-bottom: 20px" />


                    <RadzenButton Text="Add Folder"
                                  Click="AddFolderNameAsync"
                                  ButtonStyle="ButtonStyle.Success"
                                  Style="margin-bottom: 20px;height: 35px" />

                </RadzenStack>
    );
        }

        if (item != null && item.Value == "Clear")
        {
            tree.ClearSelection();
            activeFolderId = null;
            activeFolder = null;
        }

    }

    void CloseFolderPopup()
    {
        DialogService.Close();
    }

    async Task AddFolderNameAsync()
    {
        var result = await Mediator.Send(new CreateMediaFolderCommand(activeFolderId, NewFolderName));

        if (activeFolder != null)
        {
            var parentFolder = activeFolder as GetMediaFoldersQueryResponseItem;

            parentFolder.Children = await Mediator.Send(new GetMediaFoldersQuery(parentFolder.Id));

            parentFolder.HasChildren = true;
        }
        else
        {
            Directories = await Mediator.Send(new GetMediaFoldersQuery(null));
        }

        NewFolderName = string.Empty;

        DialogService.Close();

        NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Media Folder Added" });

    }

    private async Task OpenImage(string prefix, string imageUrl)
    {
        string fullPath = imageUrl;

        if (!imageUrl.StartsWith("https") && !imageUrl.StartsWith("/_content"))
        {
            fullPath = prefix + imageUrl;
        }

        await JSRuntime.InvokeVoidAsync("open", fullPath, "_blank");
    }
}



