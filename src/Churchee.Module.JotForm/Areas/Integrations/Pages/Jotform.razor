@page "/management/integrations/jotform"
@inherits BasePage
@using Churchee.Module.Jotform.Areas.Integrations.Model
@using Churchee.Module.Jotform.Features.Commands
@using Churchee.Module.Jotform.Features.Queries.GetJotformConfigurationStatus
@using Microsoft.AspNetCore.Http
@using Microsoft.Extensions.Logging
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Sections
@using MediatR
@using Churchee.Module.UI.Components
@using Radzen.Blazor
@using Radzen
@using Churchee.Common.Abstractions.Auth
@inject ICurrentUser _currentUser
@inject IHttpContextAccessor _httpContextAccessor

<PageName Name="Jotform Integration"></PageName>

<div style="max-width: 900px; margin: 40px auto;">


    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="16" class="rz-m-5">
        <svg style="width: 100px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M160 96C124.7 96 96 124.7 96 160L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 160C544 124.7 515.3 96 480 96L160 96zM421.8 203.7L436.2 218.1C451.8 233.7 451.8 259 436.2 274.7L412.4 298.5L341.4 227.5L365.2 203.7C380.8 188.1 406.1 188.1 421.8 203.7zM215.9 353L307.4 261.4L378.4 332.4L286.8 423.9C282.7 428 277.6 430.9 271.9 432.3L211.8 447.3C206.3 448.7 200.6 447.1 196.6 443.1C192.6 439.1 191 433.4 192.4 427.9L207.4 367.8C208.8 362.2 211.7 357 215.8 352.9z" /></svg>
        <RadzenStack>
            <RadzenText TextStyle="TextStyle.H4" Text="Jotform Integration" />
            <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary); max-width: 600px;">
                Post forms to Jotform.
            </RadzenText>
        </RadzenStack>

        @if (Linked)
        {
            <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Active" />
        }
        else
        {
            <RadzenBadge BadgeStyle="BadgeStyle.Base" Text="Inactive" />
        }

    </RadzenStack>

    <hr style="color: #eee; margin: 1rem 0" />


    @if (Linked)
    {
        <RadzenStack Orientation="Orientation.Vertical" JustifyContent="JustifyContent.Center">
            <h1>Jotform is set up!</h1>

        </RadzenStack>
    }
    else
    {
            <Form ButtonsOnTop="false" InputModel="@InputModel" OnSave=@(async () => await ValidSubmitForm()) />
    }

</div>


@code {

    public InputModel InputModel { get; set; } = new();

    public bool Linked { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        var response = await Mediator.Send(new GetJotformConfigurationStatusQuery());

        Linked = response.Configured;
    }

    private async Task ValidSubmitForm()
    {
        var request = _httpContextAccessor.HttpContext.Request;

        var response = await Mediator.Send(new ConfigureJotformCommand(InputModel.ApiKey));

        NotificationService.Notify(response);
    }
}