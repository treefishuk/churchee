@using Churchee.Module.Events.Models
@using Churchee.Module.UI.Models
@using Microsoft.AspNetCore.Components.Routing
@using Radzen
@using Radzen.Blazor


<RadzenStack Orientation="Orientation.Horizontal">

    <RadzenFormField Text="Start" AllowFloatingLabel="false">

        <RadzenDatePicker Max=@End?.Date DateFormat="dd-MM-yyyy HH:mm" ShowTime=true @bind-Value=Start />

    </RadzenFormField>

    <RadzenFormField Text="End" AllowFloatingLabel="false">

        <RadzenDatePicker Min=@Start?.Date DateFormat="dd-MM-yyyy HH:mm" ShowTime=true @bind-Value=End />

    </RadzenFormField>

    <RadzenToggleButton Style="margin-top: 10px;" TValue="bool" @bind-Value="Recouring" Text="@(Recouring ? "Add Single" : "Add Multiple")"></RadzenToggleButton>

    @if(Recouring){

    <RadzenFormField Text="Repeat" AllowFloatingLabel="false">
            <RadzenDropDown @bind-value=SelectedRecourance Data="TimeSegments" Placeholder="Every" TextProperty="Title" ValueProperty="Value"></RadzenDropDown>
     </RadzenFormField>

    <RadzenFormField Text="Until" AllowFloatingLabel="false">

        <RadzenDatePicker Min=@End?.Date DateFormat="dd-MM-yyyy HH:mm" ShowTime=true @bind-Value=Final />
        
    </RadzenFormField>

    }

    <RadzenButton ButtonStyle="ButtonStyle.Success" class="btn-add rz-mt-2" Icon="add" Click="AddEntry"></RadzenButton>

</RadzenStack>


<RadzenDataGrid @ref="radzenGrid" Data="@Dates" IsLoading="false" AllowSorting="true" AllowFiltering="true" AllowPaging="true" AllowColumnResize="true" AllowColumnPicking="false" PageSize="15" PagerHorizontalAlign="HorizontalAlign.Center" TItem="EventDateModel">
    <Columns>
        <RadzenDataGridColumn TItem="EventDateModel" Property="Start" Title="Start" Visible="true" FormatString="{0:dd/MM/yyyy}" SortOrder="SortOrder.Ascending" />
        <RadzenDataGridColumn TItem="EventDateModel" Property="End" Title="End" Visible="true" FormatString="{0:dd/MM/yyyy}" />
        <RadzenDataGridColumn TItem="EventDateModel" Title="" Sortable="false" Filterable="false" Width="100px" TextAlign="TextAlign.Center" Pickable="false">
            <Template Context="data">
                <RadzenButton Icon="delete" class="delete-row" ButtonStyle="ButtonStyle.Danger" Click="() => RemoveEntry(data)"></RadzenButton>
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {

    [Parameter] 
    public List<EventDateModel> Dates { get; set; }

    public DateTime? Start { get; set; }
    public DateTime? End { get; set; }
    public DateTime? Final { get; set; }

    private List<DropdownInput> TimeSegments = new();

    public string SelectedRecourance { get; set; }

    RadzenDataGrid<EventDateModel> radzenGrid = default!;

    public bool Recouring { get; set; }

    [Inject]
    protected NotificationService NotificationService { get; set; } = default!;

    private async Task AddEntry()
    {
        if (Start == null)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Validation", "Start date is required.");

            return;
        }
        if (End != null && End < Start )
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Validation", "End date must be after start date.");

            return;
        }

        await AddDates();
        await ResetFormAndReloadGrid();

    }

    private async Task AddDates()
    {
        // single entry
        if (!Recouring)
        {
            Dates.Add(new EventDateModel(Start, End));
            return;
        }

        // recurring entries
        var startValue = Start!.Value;
        var finalValue = Final!.Value;
        var duration = End.HasValue ? End.Value - Start.Value : (TimeSpan?)null;

        switch (SelectedRecourance)
        {
            case "Week":
                while (startValue <= finalValue)
                {
                    var occEnd = duration.HasValue ? startValue + duration.Value : (DateTime?)null;
                    Dates.Add(new EventDateModel(startValue, occEnd));
                    startValue = startValue.AddDays(7);
                }

                break;

            case "Month":
                while (startValue <= finalValue)
                {
                    var occEnd = duration.HasValue ? startValue + duration.Value : (DateTime?)null;
                    Dates.Add(new EventDateModel(startValue, occEnd));
                    startValue = startValue.AddMonths(1);
                }

                break;

            default:
                NotificationService.Notify(NotificationSeverity.Warning, "Recurrence", $"Unknown recurrence '{SelectedRecourance}'.");
                break;
        }

        await radzenGrid.Reload();
    }


    private async Task ResetFormAndReloadGrid()
    {
        Start = null;
        End = null;
        Final = null;
        SelectedRecourance = string.Empty;

        await radzenGrid.Reload();
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        TimeSegments = new List<DropdownInput>
        {
            new DropdownInput { Title = "Week", Value = "Week" },
            new DropdownInput { Title = "Month", Value = "Month" }
        };
    }

    private async Task RemoveEntry(EventDateModel item)
    {
        Dates.Remove(item);

        await radzenGrid.Reload();
    }

}
